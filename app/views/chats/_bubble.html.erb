<div
  data-controller="conversation-step"
  data-action="click->conversation-step#next"
>
  <%= render "shared/speech_bubble",
        class: "mt-2 grid [grid-template-rows:1fr_auto] cursor-pointer
                relative w-[550px]" do %>

    <% conversation_lines(@conv).each_with_index do |block, index| %>
      <div
        data-conversation-step-target="line"
        class="<%= index.zero? ? '' : 'hidden' %> mb-2"
      >
        <%= simple_format(h(block)) %>
      </div>
    <% end %>

    <div 
      data-conversation-step-target="nextIndicator"
      class="absolute bottom-4 right-8 text-sm text-amber-400/80 select-none"
    >
      ▼
    </div>

    <% if @choices.any? %>
      <ul 
        data-conversation-step-target="choices"
        class="flex justify-center pt-6 gap-6 hidden"
      >
        <% @choices.each do |c| %>
          <li>
            <%= link_to choice_label_html(c), chat_path(conversation_id: c.next_conversation_id),
                  class: "inline-block rounded-xl border-2 border-amber-400 bg-white px-3 py-2 hover:bg-amber-400/20 transition" %>
          </li>
        <% end %>
      </ul>
    <% else %>
      <div 
        data-conversation-step-target="closer"
        class="flex justify-end pt-2 hidden"
      >
        <%= link_to "会話をとじる", main_path,
              class: "inline-block rounded-xl border-2 border-amber-400 bg-white px-3 py-2 hover:bg-amber-400/20 transition" %>
      </div>
    <% end %>
  <% end %>
</div>